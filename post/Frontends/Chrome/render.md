# 渲染流程

## Html

HTML 的内容是由标记和文本组成。标记也称为标签

## CSS

CSS 又称为层叠样式表，是由选择器和属性组成

## JavaScript

JavaScript（简称为 JS），使用它可以使网页的内容“动”起来

## 渲染阶段

>按照渲染的时间顺序，流水线可分为如下几个子阶段：构建 DOM 树、样式计算、布局阶段、分层、绘制、分块、光栅化和合成

1. 输入内容
2. 处理过程
3. 输出内容

### DOM 树的构建

> 这是因为浏览器无法直接理解和使用 HTML，所以需要将 HTML 转换为浏览器能够理解的结构——DOM 树

树这种结构非常像我们现实生活中的“树”，其中每个点我们称为节点，相连的节点称为父子节点.

### 样式计算（Recalculate Style）

#### 把 CSS 转换为浏览器能够理解的结构

CSS 样式来源主要有三种

1. 通过 link 引用的外部 CSS 文件
2. `<style>`标记内的 CSS
3. 元素的 style 属性内嵌的 CSS

当渲染引擎接收到 CSS 文本时，会执行一个转换操作，将 CSS 文本转换为浏览器可以理解的结构

#### 转换样式表中的属性值，使其标准化

#### 计算出 DOM 树中每个节点的具体样式

## 布局阶段

### 创建布局树

### 布局计算

### 分层布局

> 渲染引擎还需要为特定的节点生成专用的图层，并生成一棵对应的图层树（LayerTree）
> 通常情况下，并不是布局树的每个节点都包含一个图层，如果一个节点没有对应的层，那么这个节点就从属于父节点的图层

1. 拥有层叠上下文属性的元素会被提升为单独的一层
2. 需要剪裁（clip）的地方也会被创建为图层

### 图层绘制

### 栅格化操作

#### 合成线程

> 合成线程会将图层划分为图块
> 合成线程会按照视口附近的图块来优先生成位图，实际生成位图的操作是由栅格化来执行的。所谓栅格化，是指将图块转换为位图

### 合成和显示

1. 渲染进程将 HTML 内容转换为能够读懂的 DOM 树结构.
2. 渲染引擎将 CSS 样式表转化为浏览器可以理解的 styleSheets，计算出 DOM 节点的样式.
3. 创建布局树，并计算元素的布局信息.
4. 对布局树进行分层，并生成分层树.
5. 为每个图层生成绘制列表，并将其提交到合成线程.
6. 合成线程将图层分成图块，并在光栅化线程池中将图块转换成位图.
7. 合成线程发送绘制图块命令 DrawQuad 给浏览器进程.
8. 浏览器进程根据 DrawQuad 消息生成页面，并显示到显示器上.

## “重排”“重绘”和“合成”

1. 更新了元素的几何属性（重排）
2. 更新元素的绘制属性（重绘）
3. 直接合成阶段

### 减少重排重绘, 方法很多

1. 使用 class 操作样式，而不是频繁操作 style
2. 避免使用 table 布局
3. 批量dom 操作，例如 createDocumentFragment，或者使用框架，例如 React
4. Debounce window resize 事件
5. 对 dom 属性的读写要分离
6. will-change: transform 做优化
